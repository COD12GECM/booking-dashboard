<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="https://cdn.shopify.com/s/files/1/0940/5274/5549/files/Untitled_design-100_550ad869-e845-4877-9844-37e6bd98b2a0.png?v=1766876822">
  <title>Dashboard - <%= owner.clinicName || 'Booking' %></title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --neo-bg: #e0e5ec;
      --neo-shadow-dark: #a3b1c6;
      --neo-shadow-light: #ffffff;
      --neo-primary: #10b981;
      --neo-danger: #ef4444;
      --neo-warning: #f59e0b;
      --neo-blue: #3b82f6;
      --neo-text: #1e293b;
      --neo-text-muted: #64748b;
    }
    
    body {
      min-height: 100vh;
      background: var(--neo-bg);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .navbar {
      background: var(--neo-bg);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px var(--neo-shadow-dark);
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .navbar-logo {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #10b981, #059669);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .navbar-logo svg {
      width: 22px;
      height: 22px;
      stroke: white;
    }
    
    .navbar-title {
      color: var(--neo-text);
      font-size: 18px;
      font-weight: 700;
    }
    
    .navbar-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .nav-link {
      color: var(--neo-text-muted);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      background: var(--neo-bg);
      box-shadow: 3px 3px 6px var(--neo-shadow-dark), -3px -3px 6px var(--neo-shadow-light);
    }
    
    .nav-link:hover {
      color: var(--neo-text);
    }
    
    .nav-link.active {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px;
    }
    
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .page-title {
      color: var(--neo-text);
      font-size: 28px;
      font-weight: 700;
    }
    
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      box-shadow: 4px 4px 8px var(--neo-shadow-dark), -4px -4px 8px var(--neo-shadow-light);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #ffffff;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #ffffff;
      padding: 10px 18px;
      font-size: 13px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
    }
    
    .btn svg {
      width: 20px;
      height: 20px;
    }
    
    .card {
      background: var(--neo-bg);
      border-radius: 24px;
      padding: 32px;
      box-shadow: 12px 12px 24px var(--neo-shadow-dark), -12px -12px 24px var(--neo-shadow-light);
    }
    
    .success-msg {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: #065f46;
      padding: 16px 24px;
      border-radius: 16px;
      margin-bottom: 24px;
      font-size: 15px;
      font-weight: 500;
    }
    
    .bookings-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .bookings-table th {
      text-align: left;
      padding: 16px;
      color: var(--neo-text-muted);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 2px solid rgba(163, 177, 198, 0.3);
    }
    
    .bookings-table td {
      padding: 16px;
      color: var(--neo-text);
      font-size: 15px;
      border-bottom: 1px solid rgba(163, 177, 198, 0.2);
      vertical-align: middle;
    }
    
    .bookings-table tr:hover {
      background: rgba(163, 177, 198, 0.1);
    }
    
    .booking-date {
      font-weight: 600;
    }
    
    .booking-time {
      background: var(--neo-bg);
      padding: 6px 14px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      box-shadow: inset 2px 2px 4px var(--neo-shadow-dark), inset -2px -2px 4px var(--neo-shadow-light);
    }
    
    .type-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }
    
    .type-booking {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: #065f46;
    }
    
    .type-blocked {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #991b1b;
    }
    
    .status-confirmed {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: #065f46;
    }
    
    .status-cancelled {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #991b1b;
    }
    
    .status-no-show {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #92400e;
    }
    
    .status-completed {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      color: #1e40af;
    }
    
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      margin: 2px;
      transition: all 0.2s ease;
    }
    
    .action-btn:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }
    
    .btn-cancel {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }
    
    .btn-complete {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
    }
    
    .btn-noshow {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }
    
    .btn-edit {
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      color: white;
      text-decoration: none;
    }
    
    .booking-row-cancelled {
      opacity: 0.6;
      background: #f5f5f5;
    }
    
    .view-tabs {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .view-tab {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: var(--neo-bg);
      color: var(--neo-text-muted);
      box-shadow: 2px 2px 4px var(--neo-shadow-dark), -2px -2px 4px var(--neo-shadow-light);
      transition: all 0.2s ease;
    }
    
    .view-tab:hover {
      color: var(--neo-text);
    }
    
    .view-tab.active {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      box-shadow: none;
    }
    
    .day-group {
      margin-bottom: 24px;
    }
    
    .day-header {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      padding: 12px 20px;
      border-radius: 12px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .day-title {
      font-weight: 700;
      color: var(--neo-text);
      font-size: 15px;
    }
    
    .day-count {
      background: var(--neo-primary);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .booking-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      transition: all 0.2s ease;
    }
    
    .booking-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .booking-card.cancelled {
      opacity: 0.5;
      background: #f9fafb;
    }
    
    .booking-time-badge {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
      min-width: 70px;
      text-align: center;
    }
    
    .booking-time-badge.blocked {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }
    
    .booking-info {
      flex: 1;
    }
    
    .booking-client {
      font-weight: 600;
      color: var(--neo-text);
      font-size: 15px;
    }
    
    .booking-service {
      color: var(--neo-text-muted);
      font-size: 13px;
      margin-top: 2px;
    }
    
    .booking-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    @media (max-width: 768px) {
      .booking-card {
        flex-direction: column;
        align-items: flex-start;
      }
      .booking-actions {
        width: 100%;
        margin-top: 12px;
      }
      .action-btn {
        flex: 1;
      }
      .view-tabs {
        flex-wrap: wrap;
      }
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }
    
    .empty-icon {
      width: 80px;
      height: 80px;
      background: var(--neo-bg);
      border-radius: 50%;
      margin: 0 auto 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: inset 4px 4px 8px var(--neo-shadow-dark), inset -4px -4px 8px var(--neo-shadow-light);
    }
    
    .empty-icon svg {
      width: 40px;
      height: 40px;
      stroke: var(--neo-text-muted);
    }
    
    .empty-title {
      color: var(--neo-text);
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .empty-text {
      color: var(--neo-text-muted);
      font-size: 16px;
      margin-bottom: 24px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }
    
    .stat-card {
      background: var(--neo-bg);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 8px 8px 16px var(--neo-shadow-dark), -8px -8px 16px var(--neo-shadow-light);
    }
    
    .stat-label {
      color: var(--neo-text-muted);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    
    .stat-value {
      color: var(--neo-text);
      font-size: 32px;
      font-weight: 700;
    }
    
    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        gap: 16px;
        padding: 16px;
      }
      .page-header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }
      .bookings-table {
        font-size: 13px;
      }
      .bookings-table th, .bookings-table td {
        padding: 12px 8px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
      </div>
      <span class="navbar-title"><%= owner.clinicName || 'Dashboard' %></span>
    </div>
    <div class="navbar-actions">
      <a href="/dashboard" class="nav-link active">Bookings</a>
      <a href="/dashboard/ai-assistant" class="nav-link" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;">ðŸ¤– AI</a>
      <a href="/dashboard/settings" class="nav-link">Settings</a>
      <a href="/logout" class="nav-link">Logout</a>
    </div>
  </nav>
  
  <div class="container">
    <% if (success) { %>
      <div class="success-msg"><%= success %></div>
    <% } %>
    
    <%
      const today = new Date().toISOString().split('T')[0];
      const confirmedBookings = bookings.filter(b => b.type === 'booking' && (b.status === 'confirmed' || !b.status));
      const completedBookings = bookings.filter(b => b.status === 'completed');
      const cancelledBookings = bookings.filter(b => b.status === 'cancelled');
      const noShowBookings = bookings.filter(b => b.status === 'no-show');
      const blockedSlots = bookings.filter(b => b.type === 'blocked' && (b.status === 'confirmed' || !b.status));
      const todayBookings = bookings.filter(b => b.date === today && (b.status === 'confirmed' || !b.status));
    %>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Active Bookings</div>
        <div class="stat-value"><%= confirmedBookings.length %></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Completed</div>
        <div class="stat-value" style="color: var(--neo-blue);"><%= completedBookings.length %></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Blocked Slots</div>
        <div class="stat-value" style="color: var(--neo-warning);"><%= blockedSlots.length %></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Today</div>
        <div class="stat-value" style="color: var(--neo-primary);"><%= todayBookings.length %></div>
      </div>
    </div>
    
    <div class="page-header">
      <div>
        <h1 class="page-title">Bookings</h1>
        <div class="view-tabs">
          <button class="view-tab active" data-view="day">Today</button>
          <button class="view-tab" data-view="week">This Week</button>
          <button class="view-tab" data-view="month">This Month</button>
          <button class="view-tab" data-view="all">All</button>
          <input type="date" id="date-picker" class="view-tab" style="padding: 6px 12px; cursor: pointer;" title="Choose specific date">
        </div>
      </div>
      <a href="/dashboard/add-booking" class="btn btn-primary">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Add Booking
      </a>
    </div>
    
    <div class="card" id="bookings-container">
      <% if (bookings.length === 0) { %>
        <div class="empty-state">
          <div class="empty-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
          </div>
          <h3 class="empty-title">No Bookings Yet</h3>
          <p class="empty-text">Your bookings will appear here once customers start booking.</p>
          <a href="/dashboard/add-booking" class="btn btn-primary">Add Manual Booking</a>
        </div>
      <% } else { %>
        <%
          // Group bookings by date
          const groupedByDate = {};
          bookings.forEach(b => {
            if (!groupedByDate[b.date]) groupedByDate[b.date] = [];
            groupedByDate[b.date].push(b);
          });
          // Sort dates descending
          const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));
        %>
        
        <% sortedDates.forEach(date => { 
          const dayBookings = groupedByDate[date].sort((a, b) => a.time.localeCompare(b.time));
          const dateObj = new Date(date + 'T00:00:00');
          const isToday = date === today;
          const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        %>
          <div class="day-group" data-date="<%= date %>">
            <div class="day-header">
              <span class="day-title"><%= isToday ? 'Today - ' : '' %><%= formattedDate %></span>
              <span class="day-count"><%= dayBookings.filter(b => b.status !== 'cancelled').length %> bookings</span>
            </div>
            
            <% dayBookings.forEach(booking => { %>
              <div class="booking-card <%= booking.status === 'cancelled' || booking.status === 'no-show' ? 'cancelled' : '' %>">
                <div class="booking-time-badge <%= booking.type === 'blocked' ? 'blocked' : '' %>">
                  <%= booking.time %>
                </div>
                <div class="booking-info">
                  <% if (booking.type === 'blocked') { %>
                    <div class="booking-client" style="color: var(--neo-warning);">Blocked Slot</div>
                    <div class="booking-service"><%= booking.notes || 'Time blocked' %></div>
                  <% } else { %>
                    <div class="booking-client"><%= booking.name %></div>
                    <div class="booking-service"><%= booking.service %> &bull; <%= booking.email %><% if (booking.phone) { %> &bull; <%= booking.phone %><% } %></div>
                  <% } %>
                </div>
                <span class="type-badge status-<%= booking.status || 'confirmed' %>" style="margin-right: 8px;"><%= booking.status || 'confirmed' %></span>
                <div class="booking-actions">
                  <% if (booking.status === 'confirmed' || !booking.status) { %>
                    <a href="/dashboard/edit-booking/<%= booking.id %>" class="action-btn btn-edit">Edit</a>
                    <form method="POST" action="/dashboard/complete/<%= booking.id %>" style="display: inline;">
                      <button type="submit" class="action-btn btn-complete">Done</button>
                    </form>
                    <form method="POST" action="/dashboard/no-show/<%= booking.id %>" style="display: inline;">
                      <button type="submit" class="action-btn btn-noshow">No-Show</button>
                    </form>
                    <form method="POST" action="/dashboard/cancel-booking/<%= booking.id %>" style="display: inline;" onsubmit="return confirm('Cancel this booking?');">
                      <button type="submit" class="action-btn btn-cancel">Cancel</button>
                    </form>
                    <% if (booking.type !== 'blocked' && booking.email) { %>
                    <form method="POST" action="/dashboard/send-reminder/<%= booking.id %>" style="display: inline;">
                      <button type="submit" class="action-btn" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;" title="Send reminder email">ðŸ“§</button>
                    </form>
                    <% } %>
                  <% } %>
                </div>
              </div>
            <% }) %>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>
  
  <script>
    // View tabs filtering
    const tabs = document.querySelectorAll('.view-tab');
    const dayGroups = document.querySelectorAll('.day-group');
    
    function getDateRange(view) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const todayStr = today.toISOString().split('T')[0];
      
      if (view === 'day') {
        return { start: todayStr, end: todayStr };
      }
      
      if (view === 'week') {
        const weekEnd = new Date(today);
        weekEnd.setDate(weekEnd.getDate() + 7);
        return { start: todayStr, end: weekEnd.toISOString().split('T')[0] };
      }
      
      if (view === 'month') {
        const monthEnd = new Date(today);
        monthEnd.setMonth(monthEnd.getMonth() + 1);
        return { start: todayStr, end: monthEnd.toISOString().split('T')[0] };
      }
      
      return null; // all
    }
    
    function filterBookings(view) {
      const range = getDateRange(view);
      
      dayGroups.forEach(group => {
        const date = group.dataset.date;
        
        if (!range) {
          group.style.display = 'block';
        } else if (date >= range.start && date <= range.end) {
          group.style.display = 'block';
        } else {
          group.style.display = 'none';
        }
      });
    }
    
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        filterBookings(tab.dataset.view);
      });
    });
    
    // Initialize with "Today" view
    filterBookings('day');
    
    // Date picker functionality
    const datePicker = document.getElementById('date-picker');
    datePicker.addEventListener('change', (e) => {
      const selectedDate = e.target.value;
      if (selectedDate) {
        tabs.forEach(t => t.classList.remove('active'));
        dayGroups.forEach(group => {
          group.style.display = group.dataset.date === selectedDate ? 'block' : 'none';
        });
      }
    });
  </script>
</body>
</html>
