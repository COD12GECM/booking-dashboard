<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#10b981">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="BuildHaze">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.svg">
  <link rel="icon" type="image/png" href="https://cdn.shopify.com/s/files/1/0940/5274/5549/files/Untitled_design-100_550ad869-e845-4877-9844-37e6bd98b2a0.png?v=1766876822">
  <title>Dashboard - <%= owner.clinicName || 'Booking' %></title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --neo-bg: #e0e5ec;
      --neo-shadow-dark: #a3b1c6;
      --neo-shadow-light: #ffffff;
      --neo-primary: #10b981;
      --neo-danger: #ef4444;
      --neo-warning: #f59e0b;
      --neo-blue: #3b82f6;
      --neo-text: #1e293b;
      --neo-text-muted: #64748b;
    }
    
    [data-theme="dark"] {
      --neo-bg: #1c1c1e;
      --neo-shadow-dark: #0a0a0b;
      --neo-shadow-light: #2c2c2e;
      --neo-text: #ffffff;
      --neo-text-muted: #a1a1a6;
      --neo-card-bg: #2c2c2e;
    }
    
    [data-theme="dark"] .card,
    [data-theme="dark"] .stat-card,
    [data-theme="dark"] .booking-card,
    [data-theme="dark"] .day-group {
      background: var(--neo-card-bg);
    }
    
    [data-theme="dark"] input,
    [data-theme="dark"] select,
    [data-theme="dark"] textarea {
      background: #3a3a3c;
      color: #ffffff;
      border-color: #48484a;
    }
    
    [data-theme="dark"] .nav-link {
      color: #ffffff;
    }
    
    [data-theme="dark"] .booking-card {
      border-left-color: var(--neo-primary);
    }
    
    .theme-toggle {
      background: var(--neo-bg);
      border: none;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 3px 3px 6px var(--neo-shadow-dark), -3px -3px 6px var(--neo-shadow-light);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .theme-toggle svg {
      width: 20px;
      height: 20px;
      stroke: var(--neo-text);
    }
    
    .theme-toggle:hover {
      transform: scale(1.05);
    }
    
    [data-theme="dark"] .sun-icon { display: block; }
    [data-theme="dark"] .moon-icon { display: none; }
    .sun-icon { display: none; }
    .moon-icon { display: block; }
    
    body {
      min-height: 100vh;
      background: var(--neo-bg);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .navbar {
      background: var(--neo-bg);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px var(--neo-shadow-dark);
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .navbar-logo {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #10b981, #059669);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .navbar-logo svg {
      width: 22px;
      height: 22px;
      stroke: white;
    }
    
    .navbar-title {
      color: var(--neo-text);
      font-size: 18px;
      font-weight: 700;
    }
    
    .navbar-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .nav-link {
      color: var(--neo-text-muted);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      background: var(--neo-bg);
      box-shadow: 3px 3px 6px var(--neo-shadow-dark), -3px -3px 6px var(--neo-shadow-light);
    }
    
    .nav-link:hover {
      color: var(--neo-text);
    }
    
    .nav-link.active {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px;
    }
    
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .page-title {
      color: var(--neo-text);
      font-size: 28px;
      font-weight: 700;
    }
    
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      box-shadow: 4px 4px 8px var(--neo-shadow-dark), -4px -4px 8px var(--neo-shadow-light);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #ffffff;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #ffffff;
      padding: 10px 18px;
      font-size: 13px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
    }
    
    .btn svg {
      width: 20px;
      height: 20px;
    }
    
    .card {
      background: var(--neo-bg);
      border-radius: 24px;
      padding: 32px;
      box-shadow: 12px 12px 24px var(--neo-shadow-dark), -12px -12px 24px var(--neo-shadow-light);
    }
    
    .success-msg {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: #065f46;
      padding: 16px 24px;
      border-radius: 16px;
      margin-bottom: 24px;
      font-size: 15px;
      font-weight: 500;
    }
    
    .bookings-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .bookings-table th {
      text-align: left;
      padding: 16px;
      color: var(--neo-text-muted);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 2px solid rgba(163, 177, 198, 0.3);
    }
    
    .bookings-table td {
      padding: 16px;
      color: var(--neo-text);
      font-size: 15px;
      border-bottom: 1px solid rgba(163, 177, 198, 0.2);
      vertical-align: middle;
    }
    
    .bookings-table tr:hover {
      background: rgba(163, 177, 198, 0.1);
    }
    
    .booking-date {
      font-weight: 600;
    }
    
    .booking-time {
      background: var(--neo-bg);
      padding: 6px 14px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      box-shadow: inset 2px 2px 4px var(--neo-shadow-dark), inset -2px -2px 4px var(--neo-shadow-light);
    }
    
    .type-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }
    
    .type-booking {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: #065f46;
    }
    
    .type-blocked {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #991b1b;
    }
    
    .status-confirmed {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: #065f46;
    }
    
    .status-cancelled {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #991b1b;
    }
    
    .status-no-show {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #92400e;
    }
    
    .status-completed {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      color: #1e40af;
    }
    
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      margin: 2px;
      transition: all 0.2s ease;
    }
    
    .action-btn:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }
    
    .btn-cancel {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }
    
    .btn-complete {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
    }
    
    .btn-noshow {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }
    
    .btn-edit {
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      color: white;
      text-decoration: none;
    }
    
    .booking-row-cancelled {
      opacity: 0.6;
      background: #f5f5f5;
    }
    
    .view-tabs {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .view-tab {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: var(--neo-bg);
      color: var(--neo-text);
      box-shadow: 2px 2px 4px var(--neo-shadow-dark), -2px -2px 4px var(--neo-shadow-light);
      transition: all 0.2s ease;
    }
    
    .view-tab[type="date"] {
      color: #000000 !important;
      font-weight: 700;
      -webkit-text-fill-color: #000000;
      min-width: 130px;
      background: var(--neo-bg);
      box-shadow: inset 3px 3px 6px var(--neo-shadow-dark), inset -3px -3px 6px var(--neo-shadow-light);
      font-size: 16px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .view-tab[type="date"]::-webkit-date-and-time-value {
      text-align: center;
      color: #000000;
    }
    
    .view-tab:hover {
      color: var(--neo-text);
    }
    
    .view-tab.active {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      box-shadow: none;
    }
    
    .day-group {
      margin-bottom: 24px;
    }
    
    .day-header {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      padding: 12px 20px;
      border-radius: 12px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .day-title {
      font-weight: 700;
      color: var(--neo-text);
      font-size: 15px;
    }
    
    .day-count {
      background: var(--neo-primary);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .booking-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      transition: all 0.2s ease;
    }
    
    .booking-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .booking-card.cancelled {
      opacity: 0.5;
      background: #f9fafb;
    }
    
    .booking-card.needs-action {
      border: 3px solid #ef4444;
      background: #fef2f2;
      animation: pulse-border 2s infinite;
    }
    
    @keyframes pulse-border {
      0%, 100% { border-color: #ef4444; }
      50% { border-color: #fca5a5; }
    }
    
    .booking-time-badge {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
      min-width: 70px;
      text-align: center;
    }
    
    .booking-time-badge.blocked {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }
    
    .booking-info {
      flex: 1;
    }
    
    .booking-client {
      font-weight: 600;
      color: var(--neo-text);
      font-size: 15px;
    }
    
    .booking-service {
      color: var(--neo-text-muted);
      font-size: 13px;
      margin-top: 2px;
    }
    
    .booking-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 12px 8px;
      }
      .booking-card {
        flex-direction: column;
        align-items: flex-start;
        padding: 12px;
      }
      .booking-actions {
        width: 100%;
        margin-top: 12px;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      .action-btn {
        padding: 10px 8px;
        font-size: 12px;
        text-align: center;
        justify-content: center;
      }
      .view-tabs {
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
      }
      .view-tab {
        padding: 10px 16px;
        font-size: 13px;
      }
      .view-tab[type="date"] {
        width: auto;
        margin-top: 0;
        font-size: 16px;
      }
      .booking-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .action-btn {
        padding: 12px 16px;
        font-size: 13px;
        min-width: auto;
        flex: 0 0 auto;
      }
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .stat-card {
        padding: 20px;
      }
      .page-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      .page-header h1 {
        font-size: 24px;
        text-align: center;
      }
      .page-header .btn {
        width: 100%;
        justify-content: center;
        padding: 14px 20px;
      }
      .navbar {
        padding: 12px;
      }
      .navbar-brand {
        display: none;
      }
      .navbar-actions {
        width: 100%;
        justify-content: space-between;
        gap: 8px;
      }
      .nav-link {
        padding: 10px 14px;
        font-size: 13px;
      }
      .day-header {
        padding: 10px 14px;
        flex-wrap: wrap;
        gap: 8px;
      }
      .day-title {
        font-size: 14px;
      }
      .booking-info {
        width: 100%;
      }
      .booking-client {
        font-size: 16px;
      }
      .booking-service {
        font-size: 12px;
        word-break: break-word;
      }
      .card {
        padding: 16px;
        border-radius: 16px;
      }
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }
    
    .empty-icon {
      width: 80px;
      height: 80px;
      background: var(--neo-bg);
      border-radius: 50%;
      margin: 0 auto 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: inset 4px 4px 8px var(--neo-shadow-dark), inset -4px -4px 8px var(--neo-shadow-light);
    }
    
    .empty-icon svg {
      width: 40px;
      height: 40px;
      stroke: var(--neo-text-muted);
    }
    
    .empty-title {
      color: var(--neo-text);
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .empty-text {
      color: var(--neo-text-muted);
      font-size: 16px;
      margin-bottom: 24px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }
    
    .stat-card {
      background: var(--neo-bg);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 8px 8px 16px var(--neo-shadow-dark), -8px -8px 16px var(--neo-shadow-light);
    }
    
    .stat-label {
      color: var(--neo-text-muted);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    
    .stat-value {
      color: var(--neo-text);
      font-size: 32px;
      font-weight: 700;
    }
    
    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        gap: 16px;
        padding: 16px;
      }
      .page-header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }
      .bookings-table {
        font-size: 13px;
      }
      .bookings-table th, .bookings-table td {
        padding: 12px 8px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
      </div>
      <span class="navbar-title"><%= owner.clinicName || 'Dashboard' %></span>
    </div>
    <div class="navbar-actions">
      <a href="/dashboard" class="nav-link active">Bookings</a>
      <a href="/dashboard/ai-assistant" class="nav-link" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; display: inline; vertical-align: middle; margin-right: 4px;"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>AI</a>
      <a href="/dashboard/settings" class="nav-link">Settings</a>
      <button type="button" class="theme-toggle" id="theme-toggle" title="Toggle dark mode">
        <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      </button>
      <a href="/logout" class="nav-link">Logout</a>
    </div>
  </nav>
  
  <div class="container">
    <% if (success) { %>
      <div class="success-msg"><%= success %></div>
    <% } %>
    
    <%
      const today = new Date().toISOString().split('T')[0];
      const confirmedBookings = bookings.filter(b => b.type === 'booking' && (b.status === 'confirmed' || !b.status));
      const completedBookings = bookings.filter(b => b.status === 'completed');
      const cancelledBookings = bookings.filter(b => b.status === 'cancelled');
      const noShowBookings = bookings.filter(b => b.status === 'no-show');
      const blockedSlots = bookings.filter(b => b.type === 'blocked' && (b.status === 'confirmed' || !b.status));
      const todayBookings = bookings.filter(b => b.date === today && (b.status === 'confirmed' || !b.status));
    %>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Active Bookings</div>
        <div class="stat-value"><%= confirmedBookings.length %></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Completed</div>
        <div class="stat-value" style="color: var(--neo-blue);"><%= completedBookings.length %></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Blocked Slots</div>
        <div class="stat-value" style="color: var(--neo-warning);"><%= blockedSlots.length %></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Today</div>
        <div class="stat-value" style="color: var(--neo-primary);"><%= todayBookings.length %></div>
      </div>
    </div>
    
    <div class="page-header">
      <div>
        <h1 class="page-title">Bookings</h1>
        <div class="view-tabs">
          <button class="view-tab active" data-view="day">Today</button>
          <button class="view-tab" data-view="week">This Week</button>
          <button class="view-tab" data-view="month">This Month</button>
          <button class="view-tab" data-view="all">All</button>
          <input type="date" id="date-picker" class="view-tab" style="padding: 8px 12px; cursor: pointer;" title="Choose specific date" value="<%= new Date().toISOString().split('T')[0] %>">
        </div>
      </div>
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button type="button" onclick="document.getElementById('dayoff-modal').style.display='flex'" class="btn" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
            <circle cx="12" cy="12" r="10"/>
            <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
          </svg>
          Day Off
        </button>
        <a href="/dashboard/add-booking" class="btn btn-primary">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Add Booking
        </a>
      </div>
    </div>
    
    <!-- Day Off Modal -->
    <div id="dayoff-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px;">
      <div style="background: var(--neo-bg); border-radius: 20px; padding: 32px; max-width: 400px; width: 100%; box-shadow: 12px 12px 24px var(--neo-shadow-dark), -12px -12px 24px var(--neo-shadow-light);">
        <h3 style="margin-bottom: 20px; color: var(--neo-text); font-size: 20px;">Schedule Day Off</h3>
        <form method="POST" action="/dashboard/day-off">
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--neo-text);">Date</label>
            <input type="date" name="date" required value="<%= new Date().toISOString().split('T')[0] %>" style="width: 100%; padding: 12px; border: none; border-radius: 10px; background: var(--neo-bg); box-shadow: inset 3px 3px 6px var(--neo-shadow-dark), inset -3px -3px 6px var(--neo-shadow-light); font-size: 16px;">
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--neo-text);">From</label>
              <input type="time" name="startTime" value="09:00" style="width: 100%; padding: 12px; border: none; border-radius: 10px; background: var(--neo-bg); box-shadow: inset 3px 3px 6px var(--neo-shadow-dark), inset -3px -3px 6px var(--neo-shadow-light); font-size: 16px;">
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--neo-text);">To</label>
              <input type="time" name="endTime" value="17:00" style="width: 100%; padding: 12px; border: none; border-radius: 10px; background: var(--neo-bg); box-shadow: inset 3px 3px 6px var(--neo-shadow-dark), inset -3px -3px 6px var(--neo-shadow-light); font-size: 16px;">
            </div>
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--neo-text);">Reason (Optional)</label>
            <input type="text" name="reason" placeholder="e.g., Conference, Vacation..." style="width: 100%; padding: 12px; border: none; border-radius: 10px; background: var(--neo-bg); box-shadow: inset 3px 3px 6px var(--neo-shadow-dark), inset -3px -3px 6px var(--neo-shadow-light); font-size: 16px;">
          </div>
          <% if (owner.teamMembers && owner.teamMembers.length > 0) { %>
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--neo-text);">Team Member (Optional)</label>
            <select name="teamMemberId" style="width: 100%; padding: 12px; border: none; border-radius: 10px; background: var(--neo-bg); box-shadow: inset 3px 3px 6px var(--neo-shadow-dark), inset -3px -3px 6px var(--neo-shadow-light); font-size: 16px;">
              <option value="">All Team Members</option>
              <% owner.teamMembers.filter(m => m.isActive !== false).forEach(member => { %>
                <option value="<%= member._id %>"><%= member.name %></option>
              <% }) %>
            </select>
          </div>
          <% } %>
          <div style="display: flex; gap: 12px;">
            <button type="button" onclick="document.getElementById('dayoff-modal').style.display='none'" style="flex: 1; padding: 14px; border: none; border-radius: 10px; background: var(--neo-bg); color: var(--neo-text); font-weight: 600; cursor: pointer; box-shadow: 3px 3px 6px var(--neo-shadow-dark), -3px -3px 6px var(--neo-shadow-light);">Cancel</button>
            <button type="submit" style="flex: 1; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; font-weight: 600; cursor: pointer;">Block Time</button>
          </div>
        </form>
      </div>
    </div>
    
    <div class="card" id="bookings-container">
      <% if (bookings.length === 0) { %>
        <div class="empty-state">
          <div class="empty-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
          </div>
          <h3 class="empty-title">No Bookings Yet</h3>
          <p class="empty-text">Your bookings will appear here once customers start booking.</p>
          <a href="/dashboard/add-booking" class="btn btn-primary">Add Manual Booking</a>
        </div>
      <% } else { %>
        <%
          // Group bookings by date
          const groupedByDate = {};
          bookings.forEach(b => {
            if (!groupedByDate[b.date]) groupedByDate[b.date] = [];
            groupedByDate[b.date].push(b);
          });
          // Sort dates descending
          const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));
        %>
        
        <% sortedDates.forEach(date => { 
          const dayBookings = groupedByDate[date].sort((a, b) => a.time.localeCompare(b.time));
          const dateObj = new Date(date + 'T00:00:00');
          const isToday = date === today;
          const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        %>
          <div class="day-group" data-date="<%= date %>">
            <div class="day-header">
              <span class="day-title"><%= isToday ? 'Today - ' : '' %><%= formattedDate %></span>
              <span class="day-count"><%= dayBookings.filter(b => b.status !== 'cancelled').length %> bookings</span>
            </div>
            
            <% dayBookings.forEach(booking => { 
                const bookingDateTime = new Date(booking.date + 'T' + booking.time);
                const now = new Date();
                const isPast = bookingDateTime < now;
                const needsAction = isPast && (booking.status === 'confirmed' || !booking.status) && booking.type !== 'blocked';
              %>
              <div class="booking-card <%= booking.status === 'cancelled' || booking.status === 'no-show' ? 'cancelled' : '' %><%= needsAction ? ' needs-action' : '' %>">
                <div class="booking-time-badge <%= booking.type === 'blocked' ? 'blocked' : '' %>">
                  <%= booking.time %>
                </div>
                <div class="booking-info">
                  <% if (booking.type === 'blocked') { %>
                    <div class="booking-client" style="color: var(--neo-warning);">Blocked Slot</div>
                    <div class="booking-service"><%= booking.notes || 'Time blocked' %><% if (booking.teamMemberName) { %> &bull; <span style="color: var(--neo-primary);"><%= booking.teamMemberName %></span><% } %></div>
                  <% } else { %>
                    <div class="booking-client"><a href="#" class="client-history-link" data-email="<%= booking.email %>" data-name="<%= booking.name %>" style="color: inherit; text-decoration: none; border-bottom: 1px dashed var(--neo-text-muted);"><%= booking.name %></a><% if (booking.teamMemberName) { %> <span style="font-size: 12px; color: var(--neo-primary); font-weight: 500;">with <%= booking.teamMemberName %></span><% } %></div>
                    <div class="booking-service"><%= booking.service %> &bull; <%= booking.email %><% if (booking.phone) { %> &bull; <%= booking.phone %><% } %></div>
                  <% } %>
                </div>
                <span class="type-badge status-<%= booking.status || 'confirmed' %>" style="margin-right: 8px;"><%= booking.status || 'confirmed' %></span>
                <div class="booking-actions">
                  <% if (booking.status === 'confirmed' || !booking.status) { %>
                    <a href="/dashboard/edit-booking/<%= booking.id %>" class="action-btn btn-edit">Edit</a>
                    <form method="POST" action="/dashboard/complete/<%= booking.id %>" style="display: inline;">
                      <button type="submit" class="action-btn btn-complete">Done</button>
                    </form>
                    <form method="POST" action="/dashboard/no-show/<%= booking.id %>" style="display: inline;">
                      <button type="submit" class="action-btn btn-noshow">No-Show</button>
                    </form>
                    <form method="POST" action="/dashboard/cancel-booking/<%= booking.id %>" style="display: inline;" onsubmit="return confirm('Cancel this booking?');">
                      <button type="submit" class="action-btn btn-cancel">Cancel</button>
                    </form>
                    <% if (booking.type !== 'blocked' && booking.email) { %>
                    <form method="POST" action="/dashboard/send-reminder/<%= booking.id %>" style="display: inline;">
                      <button type="submit" class="action-btn" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 6px 10px;" title="Send reminder email">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                      </button>
                    </form>
                    <% } %>
                    <% if (booking.type !== 'blocked' && booking.phone) { %>
                    <a href="tel:<%= booking.phone.replace(/\s/g, '') %>" class="action-btn" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 6px 10px;" title="Call client">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                    </a>
                    <a href="https://wa.me/<%= booking.phone.replace(/[^0-9]/g, '') %>?text=Hi%20<%= encodeURIComponent(booking.name) %>%2C%20this%20is%20a%20reminder%20about%20your%20appointment%20on%20<%= booking.date %>%20at%20<%= booking.time %>." class="action-btn" style="background: linear-gradient(135deg, #25D366, #128C7E); color: white; padding: 6px 10px;" title="WhatsApp" target="_blank">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    </a>
                    <% } %>
                  <% } %>
                </div>
              </div>
            <% }) %>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>
  
  <!-- Customer History Modal -->
  <div id="customer-history-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--neo-bg); border-radius: 20px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color: var(--neo-text); font-size: 18px;" id="history-client-name">Client History</h3>
        <button onclick="closeHistoryModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--neo-text-muted);">&times;</button>
      </div>
      <div id="history-content" style="color: var(--neo-text);">
        <p style="text-align: center; color: var(--neo-text-muted);">Loading...</p>
      </div>
    </div>
  </div>
  
  <script>
    // Customer History Modal
    function closeHistoryModal() {
      document.getElementById('customer-history-modal').style.display = 'none';
    }
    
    document.querySelectorAll('.client-history-link').forEach(link => {
      link.addEventListener('click', async (e) => {
        e.preventDefault();
        const email = link.dataset.email;
        const name = link.dataset.name;
        
        document.getElementById('history-client-name').textContent = name + ' - History';
        document.getElementById('customer-history-modal').style.display = 'flex';
        document.getElementById('history-content').innerHTML = '<p style="text-align: center; color: var(--neo-text-muted);">Loading...</p>';
        
        try {
          const response = await fetch('/api/client-history?email=' + encodeURIComponent(email));
          const data = await response.json();
          
          if (data.bookings && data.bookings.length > 0) {
            let html = '<div style="margin-bottom: 16px; padding: 16px; background: var(--neo-card-bg, #f0f0f0); border-radius: 12px;">';
            html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">';
            html += '<div><div style="font-size: 24px; font-weight: 700; color: var(--neo-primary);">' + data.stats.total + '</div><div style="font-size: 11px; color: var(--neo-text-muted);">Total</div></div>';
            html += '<div><div style="font-size: 24px; font-weight: 700; color: #10b981;">' + data.stats.completed + '</div><div style="font-size: 11px; color: var(--neo-text-muted);">Completed</div></div>';
            html += '<div><div style="font-size: 24px; font-weight: 700; color: #ef4444;">' + data.stats.cancelled + '</div><div style="font-size: 11px; color: var(--neo-text-muted);">Cancelled</div></div>';
            html += '</div></div>';
            
            html += '<h4 style="margin-bottom: 12px; color: var(--neo-text);">Recent Bookings</h4>';
            data.bookings.slice(0, 10).forEach(b => {
              const statusColor = b.status === 'completed' ? '#10b981' : b.status === 'cancelled' ? '#ef4444' : '#3b82f6';
              html += '<div style="padding: 12px; border-left: 3px solid ' + statusColor + '; margin-bottom: 8px; background: var(--neo-card-bg, #f5f5f5); border-radius: 8px;">';
              html += '<div style="font-weight: 600;">' + b.date + ' at ' + b.time + '</div>';
              html += '<div style="font-size: 13px; color: var(--neo-text-muted);">' + b.service + ' - <span style="color: ' + statusColor + ';">' + (b.status || 'confirmed') + '</span></div>';
              html += '</div>';
            });
            
            document.getElementById('history-content').innerHTML = html;
          } else {
            document.getElementById('history-content').innerHTML = '<p style="text-align: center; color: var(--neo-text-muted);">No booking history found for this client.</p>';
          }
        } catch (err) {
          document.getElementById('history-content').innerHTML = '<p style="text-align: center; color: #ef4444;">Error loading history</p>';
        }
      });
    });
    
    // View tabs filtering
    const tabs = document.querySelectorAll('.view-tab');
    const dayGroups = document.querySelectorAll('.day-group');
    
    function getDateRange(view) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const todayStr = today.toISOString().split('T')[0];
      
      if (view === 'day') {
        return { start: todayStr, end: todayStr };
      }
      
      if (view === 'week') {
        const weekEnd = new Date(today);
        weekEnd.setDate(weekEnd.getDate() + 7);
        return { start: todayStr, end: weekEnd.toISOString().split('T')[0] };
      }
      
      if (view === 'month') {
        const monthEnd = new Date(today);
        monthEnd.setMonth(monthEnd.getMonth() + 1);
        return { start: todayStr, end: monthEnd.toISOString().split('T')[0] };
      }
      
      return null; // all
    }
    
    function filterBookings(view) {
      const range = getDateRange(view);
      
      dayGroups.forEach(group => {
        const date = group.dataset.date;
        
        if (!range) {
          group.style.display = 'block';
        } else if (date >= range.start && date <= range.end) {
          group.style.display = 'block';
        } else {
          group.style.display = 'none';
        }
      });
    }
    
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        filterBookings(tab.dataset.view);
      });
    });
    
    // Initialize with "Today" view
    filterBookings('day');
    
    // Date picker functionality
    const datePicker = document.getElementById('date-picker');
    datePicker.addEventListener('change', (e) => {
      const selectedDate = e.target.value;
      if (selectedDate) {
        tabs.forEach(t => t.classList.remove('active'));
        dayGroups.forEach(group => {
          group.style.display = group.dataset.date === selectedDate ? 'block' : 'none';
        });
      }
    });
    
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW registration failed'));
      });
    }
    
    // Dark Mode Toggle
    const themeToggle = document.getElementById('theme-toggle');
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    
    themeToggle.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    });
  </script>
</body>
</html>
